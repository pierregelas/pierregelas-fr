# Services du dossier `src/services`
_Last updated: 2025-10-24 — Plugin v0.6.0_

Cette fiche récapitule chaque module de services et détaille pour chacune de leurs fonctions : leur rôle, les invariants qu'elles gèrent et les actions (ou autres modules) qui les invoquent dans le plugin. Les descriptions suivent l'ordre alphabétique des fichiers.

## `actionLogger.ts`
- **`beginActionLog(vault, actionId, opts)`** : crée un fichier Markdown de log dans `wp_tags/logs_tests`, initialise un frontmatter riche (compteurs diff/applied, métadonnées CSV) puis renvoie le chemin et un horodatage de départ.【F:src/services/actionLogger.ts†L117-L209】 La commande `updateTagsFromLastCsv` utilise cette étape lorsque le logging est activé afin de tracer les opérations sur la table locale des tags.【F:src/actions/tags.ts†L92-L142】
- **`appendSection(vault, logPath, title, bodyMd)`** : relit le log ciblé, ajoute éventuellement un titre de section (`## …`) et concatène un bloc Markdown fourni (CSV brut, table locale, diff, etc.).【F:src/services/actionLogger.ts†L211-L235】 Toutes les annexes déposées pendant l'action Tags (CSV lu, table avant, aperçu de diff, sélection appliquée) passent par ce helper.【F:src/actions/tags.ts†L115-L245】
- **`finalizeActionLog(vault, logPath, startedAt, fin)`** : relit le log, calcule la durée, applique un patch YAML (statut, compteurs diff/applied, résumé) puis ajoute éventuellement la table finale rendue si l'action a été exécutée.【F:src/services/actionLogger.ts†L237-L309】 La commande de synchronisation des tags s'en sert dans tous les scénarios de sortie (succès, annulation, erreur) pour consigner les résultats et le backup écrit.【F:src/actions/tags.ts†L172-L291】

## `archivesUtils.ts`
- **`isJournalPhotoCategory(postCat)`** : vérifie que le champ `post_cat` contient la catégorie `journal-photo`, qu'il soit une chaîne unique ou une liste hétérogène.【F:src/services/archivesUtils.ts†L4-L23】 Les actions Archives/Restes (création et mise à jour) et la commande de recalcul Journal s'en servent comme précondition de sécurité avant toute dérivation.【F:src/actions/createArchives.ts†L29-L145】【F:src/actions/createRestes.ts†L29-L145】【F:src/actions/journalRecalc.ts†L27-L36】
- **`deriveArchivesTitlesFromLinkText(linkText)`** : découpe le texte du wikilink d'archives pour générer `post_titre_1`, `post_titre_2` (à partir du segment « Archives… ») et `post_titre_full` avec ponctuation normalisée.【F:src/services/archivesUtils.ts†L25-L58】 La création et la mise à jour des notes Archives l'utilisent pour reconstruire les titres cibles depuis le lien stocké côté Journal.【F:src/actions/createArchives.ts†L74-L205】
- **`toBfImageNameFromWp(imgFilenameFromJournal)`** : remplace chaque suffixe `_WP` par `_BF` afin d'obtenir le nom d'image attendu par la note Archives.【F:src/services/archivesUtils.ts†L60-L68】 Lors des mises à jour Archives, ce renommage sert à proposer la couverture BF à partir du visuel Journal.【F:src/actions/createArchives.ts†L235-L240】
- **`toReiImageNameFromWp(imgFilenameFromJournal)`** : même règle que ci-dessus mais vers `_REI` pour les Restes du futur.【F:src/services/archivesUtils.ts†L70-L114】 La procédure de mise à jour Restes exploite cette conversion lors du recalcul automatique.【F:src/actions/createRestes.ts†L232-L239】
- **`deriveRestesTitlesFromLinkText(linkText)`** : miroir du builder Archives avec le mot-clé « Restes » pour produire les trois variantes de titre Restes.【F:src/services/archivesUtils.ts†L86-L114】 Les workflows Restes (création/mise à jour) s'appuient dessus pour remplir les champs `post_titre_*` cibles.【F:src/actions/createRestes.ts†L74-L235】

## `dateUtils.ts`
- **`extractIsoDateFromFilename(filename)`** : isole la date/heure initiale d'un nom `AAAA-MM-JJ-hh-mm - Titre…` et la convertit en `YYYY-MM-DDThh:mm:00`.【F:src/services/dateUtils.ts†L4-L17】 Utilisé lors de la création des notes Minutes et Journal ainsi que pour dériver les titres Journal.【F:src/actions/createMinutes.ts†L40-L58】【F:src/actions/createJournal.ts†L51-L57】【F:src/services/journalUtils.ts†L13-L21】
- **`formatDateToFrench(isoDate)`** : formate une date ISO en libellé français avec heure (`Samedi 14 juin 2025 à 15h57.`).【F:src/services/dateUtils.ts†L19-L72】 Sert à produire `post_titre_2` dans la commande Minutes à partir de la date extraite.【F:src/actions/createMinutes.ts†L52-L70】
- **`formatDateToFrenchDayOnly(isoDate, lowercaseDay)`** : variante sans l'heure, utilisée pour générer « Journal du … » ou recalculer les libellés Journal existants.【F:src/services/dateUtils.ts†L74-L98】 Appelée par les utilitaires Journal lors des créations et par la commande de recalcul des titres.【F:src/services/journalUtils.ts†L13-L21】【F:src/actions/journalRecalc.ts†L50-L89】

## `fileUtils.ts`
- **`createNoteFile(vault, filename, yaml, body, opts)`** : sécurise le nom de fichier, vérifie l'absence de collision, crée au besoin les dossiers, assemble YAML+corps puis écrit la note Markdown dans la vault.【F:src/services/fileUtils.ts†L11-L50】 Toutes les actions de création (Journal, Minutes, Archives, Restes) s'appuient sur ce service pour matérialiser la note finale et afficher une notice de succès ou d'erreur.【F:src/actions/createJournal.ts†L87-L94】【F:src/actions/createMinutes.ts†L85-L92】【F:src/actions/createArchives.ts†L103-L124】【F:src/actions/createRestes.ts†L103-L124】

## `imageUtils.ts`
- **`buildMinutesImageFilename(fromVideoFilename)`** : génère le nom de la vignette Minutes en concaténant `YYYYMMDD` avec les huit premiers caractères nettoyés du titre et le suffixe `_mvign.webp`.【F:src/services/imageUtils.ts†L4-L37】 L'action Minutes l'utilise pour peupler le YAML et la section vignette à partir du nom du fichier vidéo fourni.【F:src/actions/createMinutes.ts†L58-L83】
- **`toBfFromWp(imageName)`** : helper générique qui transforme `_WP` en `_BF` dans un nom d'image (utile aux flux Archives).【F:src/services/imageUtils.ts†L39-L47】

## `journalUtils.ts`
- **`deriveJournalTitlesFromFilename(filename)`** : combine `extractIsoDateFromFilename`, `extractTitleFromFilename` et `formatDateToFrenchDayOnly` pour retourner les trois champs `post_titre_*` cohérents avec un dossier Journal donné.【F:src/services/journalUtils.ts†L7-L22】 L'action Journal s'en sert pour préremplir les titres lors de la création.【F:src/actions/createJournal.ts†L51-L75】
- **`parseImageIdFromName(imageName)`** : extrait l'identifiant numérique central (`4075037` dans `…_4075037_WP.webp`) pour des besoins d'intégration externes.【F:src/services/journalUtils.ts†L24-L36】
- **`buildArchivesLinkTitle(postTitreFull)`** : transforme un titre Journal en libellé Archives (remplacement du mot « Journal », normalisation des ponctuations, ajout `?`) puis le renvoie au format wikilink.【F:src/services/journalUtils.ts†L38-L45】 Utilisé lors de la création Journal, dans les actions Archives (dérivation / détection de renommage) et pendant le recalcul Journal.【F:src/actions/createJournal.ts†L63-L74】【F:src/actions/createArchives.ts†L200-L205】【F:src/actions/journalRecalc.ts†L57-L89】
- **`buildRestesLinkTitle(postTitreFull)`** : équivalent pour les Restes, renvoyant le wikilink normalisé.【F:src/services/journalUtils.ts†L47-L53】 Appelé lors des créations Journal/Restes et dans la commande de recalcul.【F:src/actions/createJournal.ts†L63-L74】【F:src/actions/createRestes.ts†L197-L239】【F:src/actions/journalRecalc.ts†L57-L89】

## `tagsCsv.ts`
- **Constantes `TAGS_CSV_DIR`, `TAGS_CSV_PATTERN`, `CSV_EXPECTED_HEADERS`** : définissent respectivement l'emplacement des exports WordPress, le motif de nommage (`AAAA-MM-JJ_export_tags.csv`) et l'entête attendue.【F:src/services/tagsCsv.ts†L8-L15】
- **`findLatestCsv(vault)`** : parcourt les fichiers du vault pour récupérer le dernier export conforme par tri lexicographique décroissant.【F:src/services/tagsCsv.ts†L34-L47】 L'action Tags l'emploie pour sélectionner automatiquement le CSV le plus récent lors de l'import.【F:src/actions/tags.ts†L92-L110】
- **`readAndParseCsv(vault, file)`** : lit un fichier Obsidian et délègue à `parseTagsCsv` le nettoyage/normalisation des données.【F:src/services/tagsCsv.ts†L49-L53】 Directement invoqué par `updateTagsFromLastCsv` avant l'ouverture de la modale de diff.【F:src/actions/tags.ts†L70-L141】
- **`parseTagsCsv(csvContent)`** : convertit le texte CSV en lignes `TagRow` normalisées (trim/slug en minuscules, compte entier ≥ 0) tout en collectant les anomalies non bloquantes (en-tête, colonnes manquantes, slug non conforme).【F:src/services/tagsCsv.ts†L55-L126】

## `tagsDiff.ts`
- **Types `DiffKind`, `DiffItem`, `TagsDiff`** : documentent les sept groupes métiers (nouveaux tags, id/name/count update, tags à créer/modifier, problèmes) et la structure de diff retournée.【F:src/services/tagsDiff.ts†L8-L30】
- **`buildTagsDiff(csvRows, localRows)`** : compare CSV et table locale pour produire la diff complète (items, compteurs, flag d'action possible). Il gère tous les cas métier : correspondances exactes (updates ciblées), nouveaux tags, tags locaux sans équivalent CSV, cas protégés `obm/obc`, anomalies à revue manuelle.【F:src/services/tagsDiff.ts†L47-L252】 Cette fonction alimente la modale Tags et le log texte lors de l'import CSV.【F:src/actions/tags.ts†L135-L174】
- **`applyTagsDiff(localRows, apply)`** : applique séquentiellement les items cochés (ordre sécurisé : id → name → count → nouveaux) pour produire une nouvelle table locale triée, en évitant les doublons d'id/slug.【F:src/services/tagsDiff.ts†L254-L298】 Utilisé après validation de la modale pour préparer la table Markdown finale avant écriture.【F:src/actions/tags.ts†L247-L266】
- **`hasLocalWithoutIdMissingInCsv(localRows, csvRows)`** : détecte la présence de tags `obc` sans id absent du CSV afin d'alimenter le booléen `wp_update` dans le YAML.【F:src/services/tagsDiff.ts†L300-L312】 La commande Tags l'injecte autant dans la mise à jour « informative » que dans la branche « appliquer la sélection ».【F:src/actions/tags.ts†L172-L205】【F:src/actions/tags.ts†L253-L277】

## `tagsTable.ts`
- **Constantes `TAGS_TABLE_PATH` et `TABLE_HEADERS`** : localisent la table Markdown de référence et fixent l'ordre des cinq colonnes (`ob_tags_id|name|slug|count|notes`).【F:src/services/tagsTable.ts†L12-L33】
- **`findTagsTableFile(vault)`** : retourne le `TFile` associé à `wp_tags/ob_tags_table.md` si présent.【F:src/services/tagsTable.ts†L51-L58】
- **`readTagsTable(vault)`** : lit le fichier, isole le frontmatter brut et parse la première table conforme afin de fournir les lignes normalisées `LocalTagRow` avec leurs indices dans le corps.【F:src/services/tagsTable.ts†L60-L70】 C'est le point d'entrée de la commande Tags pour charger l'état local avant diff.【F:src/actions/tags.ts†L91-L142】
- **`renderTagsTable(rows)`** : reconstruit une table Markdown stable (triée par slug, valeurs nettoyées) à partir des lignes locales.【F:src/services/tagsTable.ts†L72-L101】 Après application de la diff, la commande Tags l'utilise pour produire le Markdown final.【F:src/actions/tags.ts†L247-L266】
- **`replaceTableInContent(raw, table, newTableMd)`** : remplace in-place le bloc de table dans le contenu brut, en conservant YAML et texte autour, ou ajoute la table si elle est absente.【F:src/services/tagsTable.ts†L103-L129】 Sert à injecter la table recalculée dans `ob_tags_table.md` juste avant sauvegarde.【F:src/actions/tags.ts†L253-L266】
- **`backupTagsTable(vault, file)`** : crée une sauvegarde horodatée de la table dans `wp_tags/backup/` avant toute écriture et évite l'écrasement si la cible existe déjà.【F:src/services/tagsTable.ts†L131-L151】 La commande Tags s'en sert dans les branches « aucune action » et « appliquer » pour sécuriser le fichier source.【F:src/actions/tags.ts†L172-L206】【F:src/actions/tags.ts†L247-L276】
- **`loadObsTagSlugs(io, absPath)`** : lit un tableau Markdown quelconque, repère la colonne `ob_tags_slug`, en extrait les valeurs (en dédupliquant) et renvoie la liste des slugs autorisés. Lève des erreurs explicites si le fichier ou la colonne manquent.【F:src/services/tagsTable.ts†L270-L340】 La commande « Modifier une note » l'emploie pour alimenter l'autocomplétion de la modale Tags avant d'appeler `patchTagsAndMaj`.【F:src/actions/modifyNote.ts†L90-L130】

## `titleUtils.ts`
- **`extractTitleFromFilename(filename)`** : récupère la partie texte après «  - », ajoute une majuscule initiale et un point final si besoin, fournissant `post_titre_1` prêt à l'emploi.【F:src/services/titleUtils.ts†L4-L31】 Utilisé pour les Minutes et comme brique dans `deriveJournalTitlesFromFilename`.【F:src/actions/createMinutes.ts†L46-L66】【F:src/services/journalUtils.ts†L13-L21】
- **`buildFullTitle(title1, title2)`** : concatène proprement les deux segments de titre en gérant les cas vides.【F:src/services/titleUtils.ts†L33-L44】 Sert dans la création Minutes, Journal et lors des recalculs pour reconstituer `post_titre_full` avant les liens croisés.【F:src/actions/createMinutes.ts†L58-L74】【F:src/actions/createJournal.ts†L57-L74】【F:src/actions/journalRecalc.ts†L57-L89】

## `validationUtils.ts`
- **`validateFilenameFormat(input)`** : applique la regex stricte `^\d{4}-\d{2}-\d{2}-\d{2}-\d{2} - .+$` pour valider le nom horodaté attendu par les actions Minutes et Journal.【F:src/services/validationUtils.ts†L4-L22】 Vérifié à la fois côté modale (en direct) et lors de l'exécution des commandes Minutes/Journal.【F:src/actions/createMinutes.ts†L31-L139】【F:src/actions/createJournal.ts†L30-L139】
- **`validateVideoLink(url)`** : s'assure que la chaîne reçue est une URL HTTPS valide en tirant parti de `URL` natif.【F:src/services/validationUtils.ts†L24-L36】 Les Minutes l'exigent avant de poursuivre la construction de la note.【F:src/actions/createMinutes.ts†L35-L139】
- **`validationErrorMessage(kind)`** : retourne un message lisible pour les erreurs de format (fichier ou lien vidéo) à afficher dans les notices UI.【F:src/services/validationUtils.ts†L38-L50】 Réutilisé dans la modale Minutes pour guider l'utilisateur en cas d'entrée invalide.【F:src/actions/createMinutes.ts†L31-L136】

## `yamlBuilder.ts`
- **`pushYamlBlock(lines, key, value)`** : ajoute à un tableau de lignes YAML une clé suivie d'un bloc littéral (`|`) correctement indenté, y compris un bloc vide (ligne d'indentation).【F:src/services/yamlBuilder.ts†L1-L15】 Le constructeur YAML maître l'utilise pour sérialiser les blocs multilignes (légendes d'images, etc.) lors de la génération finale.【F:src/core/yamlMaster.ts†L301-L307】

## `yamlPatch.ts`
- **`applyYamlPatch(raw, updates)`** : lit le frontmatter existant, fusionne les clés mises à jour (dot-notation incluse) tout en conservant les types natifs, puis réécrit le document complet.【F:src/services/yamlPatch.ts†L10-L55】 Employé pour patcher le YAML des logs (actionLogger), des notes Journal (recalc) et de la table des tags (métadonnées `tags_last_*`).【F:src/services/actionLogger.ts†L237-L309】【F:src/actions/journalRecalc.ts†L57-L89】【F:src/actions/tags.ts†L172-L277】
- **`patchTagsAndMaj(noteAbsPath, nextTags, io)`** : cible spécifiquement le bloc `tags` en conservant la structure YAML maître, force `maj_wp: true` seulement si la liste change et écrit le fichier si nécessaire.【F:src/services/yamlPatch.ts†L96-L144】 La commande « Modifier une note (tags) » s'en sert pour appliquer la sélection issue de la modale tout en respectant les sections d'origine.【F:src/actions/modifyNote.ts†L84-L130】
- **`setWpImportBlock(fm, data)`** : injecte dans un objet frontmatter existant les champs `wp_import_dataset_key/id` à partir des paramètres fournis (utilisation en mémoire lors de la génération du YAML).【F:src/services/yamlPatch.ts†L290-L304】 L'import WordPress s'en sert avant la sérialisation pour taguer chaque note avec l'identifiant du dataset importé.【F:src/actions/importWordpress.ts†L268-L335】
- **`patchWpImportBlock(noteAbsPath, datasetKey, datasetId, io)`** : variante qui agit directement sur fichier pour garantir la présence/mise à jour du bloc `WP-IMPORT` en conservant les sections maître.【F:src/services/yamlPatch.ts†L306-L339】
